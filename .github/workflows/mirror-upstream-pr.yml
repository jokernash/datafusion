name: Mirror upstream PR for CodeRabbit

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Upstream PR number (apache/datafusion)"
        required: true
        type: string

permissions:
  contents: write        # allow pushing branches
  pull-requests: write   # allow creating PRs
  workflows: write       # ðŸ‘ˆ allow updating .github/workflows/* via this token

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/apache/datafusion.git
          git fetch upstream

      - name: Fast-forward main to upstream/main
        run: |
          git checkout main
          # For a review-only fork, a hard reset keeps things clean.
          git reset --hard upstream/main
          git push origin main --force

      - name: Fetch upstream PR into branch
        run: |
          BRANCH="pr-${{ inputs.pr_number }}"
          git fetch upstream pull/${{ inputs.pr_number }}/head:${BRANCH}
          git checkout ${BRANCH}
          git push origin ${BRANCH} --force

      - name: Create PR in fork
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.inputs.pr_number;
            const branch = `pr-${prNumber}`;

            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CodeRabbit review for upstream PR ${prNumber}`,
              head: branch,
              base: 'main',
              body: `Shadow PR to run CodeRabbit on an upstream DataFusion pull request (ID ${prNumber}).`
            });
