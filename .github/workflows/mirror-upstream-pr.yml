name: Mirror upstream PR for CodeRabbit

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Upstream PR number (apache/datafusion)"
        required: true
        type: string

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/apache/datafusion.git
          git fetch upstream

      - name: Fetch upstream PR into branch and scrub commit messages
        run: |
          BRANCH="pr-${{ inputs.pr_number }}"
          # 1. Fetch PR into local branch
          git fetch upstream pull/${{ inputs.pr_number }}/head:${BRANCH}
          git checkout ${BRANCH}

          # 2. Rewrite commit messages to avoid apache#NNNN cross-references
          #    (only on this branch, safe for review-only use)
          git filter-branch --msg-filter '
            # replace "apache#1234" or "apache/datafusion#1234" with plain text
            sed -E "s/apache\/?datafusion#([0-9]+)/apache datafusion issue \1/g; s/apache#([0-9]+)/apache issue \1/g"
          ' ${BRANCH} || true

          # 3. Push the rewritten branch to your fork
          git push origin ${BRANCH} --force

      - name: Create PR in fork and trigger CodeRabbit
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.inputs.pr_number;
            const branch = `pr-${prNumber}`;

            // 1) Create the shadow PR in your fork
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CodeRabbit review for upstream PR ${prNumber}`,
              head: branch,
              base: 'main',
              body: `Shadow PR to run CodeRabbit on an upstream DataFusion pull request (ID ${prNumber}).`
            });

            // 2) Immediately ask CodeRabbit to review it
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: '@coderabbitai review'
            });

            core.info(`Created PR #${pr.number} and triggered CodeRabbit review.`);
