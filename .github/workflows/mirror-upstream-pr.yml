name: Mirror upstream PR for CodeRabbit

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Upstream PR number (apache/datafusion)"
        required: true
        type: string

permissions:
  contents: read          # GITHUB_TOKEN perms (we'll use PAT for pushes)
  pull-requests: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    env:
      MIRROR_PAT: ${{ secrets.MIRROR_PAT }}

    steps:
      - name: Checkout fork (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ env.MIRROR_PAT }}   # use PAT for checkout/push

      - name: Configure Git user
        run: |
          git config user.name "jokernash"
          git config user.email "jokernash@users.noreply.github.com"

      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/apache/datafusion.git
          git fetch upstream

      - name: Use PAT for origin
        run: |
          git remote set-url origin "https://x-access-token:${MIRROR_PAT}@github.com/${GITHUB_REPOSITORY}.git"

      - name: Fast-forward main to upstream/main
        run: |
          git checkout main
          # For a review-only fork, hard reset keeps it clean
          git reset --hard upstream/main
          git push origin main --force

      - name: Fetch upstream PR into branch
        run: |
          BRANCH="pr-${{ inputs.pr_number }}"
          git fetch upstream pull/${{ inputs.pr_number }}/head:${BRANCH}
          git checkout ${BRANCH}
          git push origin ${BRANCH} --force

      - name: Create PR in fork (authored by you)
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.MIRROR_PAT }}   # PR will be opened as jokernash
          script: |
            const prNumber = context.payload.inputs.pr_number;
            const branch = `pr-${prNumber}`;

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CodeRabbit review for upstream PR ${prNumber}`,
              head: branch,
              base: 'main',
              body: `Shadow PR to run CodeRabbit on an upstream DataFusion pull request (ID ${prNumber}).`
            });

            console.log(`Created PR #${pr.number} in fork`);
